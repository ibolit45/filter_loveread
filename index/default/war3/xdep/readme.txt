X-deprotect (далее "xdep") - утилита для восстановления карт для Warcraft3: RoC/TFT, поврежденных специальными утилитами ("оптимизаторами" или "протекторами") таким образом, что в игре они работают, но в редакторе - не открываются.

Следует понимать, что получить из "защищенной" карты в точности ту версию, какой она была исходно, в общем случае невозможно. Но почти всегда можно получить версию, работающую абсолютно неотличимо от оригинала, при этом свободно редактируемую.

Под "восстановлением" здесь и далее подразумевается процесс получения такой карты, которую можно открыть и сохранить в редакторе, при этом функциональность которой останется полностью идентичной исходной карте.

xdep выполняет необходимый минимум операций для такого восстановления, а также, опционально, некоторые дополнительные операции для облегчения понимания устройства карты.
(эти операции, подробно описанные ниже, могут вызывать сбой на некоторых картах, но так как для восстановления карты они не обязательны, их можно отключить в конфигурации)

xdep предназначен не столько для бездумного снятия "защиты" в 1 клик (хотя и такое использование возможно), сколько для автоматизации многих рутинных операций при "ручном" восстановлении карты. На любом шаге в автоматический процесс восстановления можно вмешаться, редактируя файлы во временной папке.

На получившейся восстановленой карте можно применять утилиты типа Deprotect, Dewidgetizer для дальнейшего восстановления, например, GUI-триггеров или объектных данных.
(в силу того, что эти операции довольно сложны, и при этом не являются необходимыми, эта утилита их не выполняет)
Или же просто редактировать скрипт карты через редактор, не выполняя рутинных операций распаковывания/запаковывания файла war3map.j из карты со всеми связанными с этим глюками.


Что конкретно делает xdep в минимальной работающей конфигурации:
- распаковывает все файлы карты в отдельную временную папку;
- восстанавливает список файлов в архиве, методом сканирования всех файлов в поисках возможных имен других файлов;
- исправляет файл war3map.w3i, намеренно повреждаемый утилитами для защиты;
- удаляет файлы (attributes), (listfile), (signature), переносит скрипт карты в war3map.j;
- восстанавливает список импортированных файлов (war3map.imp);
- восстанавливает файлы war3map.wtg, war3map.wct, war3mapUnits.doo на основе скрипта карты;
(сам скрипт карты вносится в один триггер и изменяется таким образом, чтобы карта сохранялась без ошибок в редакторе)
- собирает получившиеся файлы в новый архив, добавляя ему заголовок от исходного.

В списке дополнительных возможностей:
- переименовывание функций со "стандартными" именами, назначаемыми редактором, во избежание конфликтов имен при сохранении (эта опция необходима, если при защите карты не использовалось "запутывание" имен функций)
- подстановка кода однократно используемых функций на место их вызова: нужно для распознавания секции инициализации, для восстановлениия данных о start locations, юнитах, регионах и прочем (обычно это и так выполняется некоторыми утилитами для оптимизации)
- переименовывание глобальных переменных с "запутанными" (obfuscated) именами в нечто типа "udg_integers01"
- расстановка отступов в скрипте
- восстановление данных о start locations в файл war3mapUnits.doo на основе секции инициализации
(если эта опция отключена, war3mapUnits.doo все равно создается, но пустым, т.к. он необходим WE)

В следующих версиях планируется приблизить функциональность к той, с помощью которой была получена открытая версия доты (http://dimon.xgm.ru/opendota/), а именно:
- восстановление данных регионов, звуков, камер, юнитов в формат редактора;
- разбиение скрипта на отдельные триггеры;
- переименование функций/переменных/триггеров/регионов и прочего по заданным пользователем спискам имен;


Утилита является консольной, все параметры, включая имена входного и выходного файлов, описываются в текстовом файле xdep.ini.
Файл конфигурации снабжен более-менее подробными комментариями по каждой опции.
Для запуска достаточно прописать путь к требуемой карте в конфигурации и запустить xdep.exe.

Для работы с MPQ используется известная библиотека SFmpq.dll с консольным архиватором собственного написания.
Листфайл для архиватора находится в файле listfile.txt, включает в себя списки имен от стандартных архивов War3 TFT, а также от нескольких карт, на которых проводилось тестирование.


Автор утилиты: zibada aka DimonT, zibada@xgm.guru, ICQ 937160
Благодарность за помощь в тестировании выражается Sky.

XGM - Российский модмейкерский портал
http://xgm.guru/
